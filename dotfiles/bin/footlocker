#!/usr/bin/bash
# Author: github.com/Dauliac
# Description:
#   This is my personnal i3lock script to lock with blur and dpms
#   This is work fine with xautolock configs or anything else similar

dependencies="i3lock scrot convert"

check_integrity() {
    for requirement in ${dependencies} ; do
        command -v ${requirement} >/dev/null 2>&1 || {
            echo "[ERROR] missing ${requirement}" >&2;
        exit 1; }

    done
}

lock() {
    letterEnteredColor=98971aff
    letterRemovedColor=fabd2fff
    passwordCorrect=00000000
    passwordIncorrect=fb4934ff
    background=00000000
    foreground=ffffffff
    tmp_bg_f='/tmp/i3lock/'
    tmp_bg='lock.png'
    l_img="${tmp_bg_f}${tmp_bg}"

    if [ ! -d $tmp_bg_f ];then
        mkdir -p "${tmp_bg_f}"
    fi
    if [ -z $AUTOBG ]; then
        scrot -z "${l_img}"
    else
        cp -f $AUTOBG $l_img
    fi
    if [ -z $BLUR ]; then
        BLUR="0x5"
    fi

    convert "${l_img}" -blur $BLUR -fill black -colorize 15% "${l_img}"

    if [ -z $DPMS ]; then
        i3lock -tbn -i "${l_img}"
    else
        revertDpms() {
            xset dpms 0 0 0
        }
        trap revertDpms HUP INT TERM
        xset +dpms dpms 5 5 5
        i3lock -tbn -i "${l_img}"
        revertDpms
    fi
}

helpmenu() {
    echo "footlocker [param [options]] \n
    -d | --dpms                 : dpms screen after lock \n
    -b | --blur <0xN>           : blur effect, N is an int \n
    -p | --picture <path>       : give picture to display"
}

check_integrity

while [ ! $# -eq 0 ]
do
    case "$1" in
        --picture | -p)
            AUTOBG=$2
            ;;
        --dpms | -d)
            DPMS=1
            ;;
        --blur | -b)
            BLUR=$2
            ;;
        --help)
            helpmenu
            exit
            ;;
    esac
    shift
done
lock

